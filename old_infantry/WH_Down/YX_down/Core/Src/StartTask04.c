#include "FreeRTOS.h"
#include "task.h"
#include "main.h"
#include "cmsis_os.h"
#include "remote_control.h"
#include "PID.h"
#include "arm_math.h"
#include "time_user.h"//²»¼ÓÕâ¸öÒ²¿ÉÒÔ£¬ÒòÎªÀïÃæÊÇÖÐ¶Ïº¯Êý£¬ÏµÍ³»á×Ô¼ºÈ¥ÕÒ

void StartTask04(void const * argument)//yaw???????yaw???õ???6020??ID?2??????????õ???3508??ID?5????????down_can_1????
{
	/*????????????g??????????
	HAL_TIM_Base_Start_IT(&htim1);//?????????1?????????????????tim.c???????????????
	round_shoot=3+0.015;		//???????????,??????????g???????????????????????h?????????????????
	time=100;		//100???1s,???????
	down=(time/100);
	up=(19*round_shoot*60);*/
//	target_speed[4]=up;//???????ÿ??????????????ô???????????????????????????????????
	pid_init(&motor_pid[4],20,0.01,5,16384,16384);//??'??????????pid?????????????????
	up=19*180;
	down=1;
	//yaw??
	//target_angle=0;?????????????
	max_yaw_speed=240;//??????????????,6020û???????
	pid_init(&motor_pid[5],60,10,5,30000,30000);//??'??????????pid?????????????????

  for(;;)
  {
		/*??????Yaw,??????PID????g?
		motor_info[5].set_voltage=pid_yaw_calc(&motor_pid[5],motor_info[5].rotor_speed,max_yaw_speed);
			if(err_angle<200)//??????????
		{
			motor_info[5].set_voltage=pid_calc(&motor_pid[5],0,motor_info[5].rotor_speed);
		}*/
		//?????g?
		if(rc_ctrl.rc.s[1]==3)//???g?
		{
			if(rc_ctrl.rc.ch[0]>1124&&rc_ctrl.rc.ch[0]<=1684)
			{
				target_speed[5]=60;
			}
			else if(rc_ctrl.rc.ch[0]>=324&&rc_ctrl.rc.ch[0]<924)
			{
				target_speed[5]=-60;
			}
			else
			{
				target_speed[5]=0;
			}
			motor_info[5].set_voltage = pid_calc(&motor_pid[5], target_speed[5], motor_info[5].rotor_speed);
		}
		//???????
		if(rc_ctrl.rc.s[1]==1)//??????g????????
		{
			flag_shoot=1;
		}
		else
		{
			flag_shoot=0;
		}

		if(flag_shoot==1)//??????????????????'???
		{
			motor_info[4].set_voltage=pid_calc(&motor_pid[4],up/down,motor_info[4].rotor_speed);//?????PID?k????
			set_motor_voltage(1, 
                      motor_info[4].set_voltage, 
                      motor_info[5].set_voltage, 
                      motor_info[6].set_voltage, 
                      0);
		}
		else if(flag_shoot==0)
		{
			motor_info[4].set_voltage=pid_calc(&motor_pid[4],0,motor_info[4].rotor_speed);//?????PID?k????
			set_motor_voltage(1, 
                      motor_info[4].set_voltage, 
                      motor_info[5].set_voltage, 
                      motor_info[6].set_voltage, 
                      0);
		}

		
		osDelay(1);
  }

}